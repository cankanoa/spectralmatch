
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://spectralmatch.github.io/spectralmatch/api/match/">
      
      
        <link rel="prev" href="../../examples/benchmark/">
      
      
        <link rel="next" href="../mask/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Matching Algorithms - spectralmatch</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../docs/overrides/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spectralmatch.match.global_regression.global_regression" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="spectralmatch" class="md-header__button md-logo" aria-label="spectralmatch" data-md-component="logo">
      
  <img src="../../images/icon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            spectralmatch
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Matching Algorithms
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/spectralmatch/spectralmatch" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="spectralmatch" class="md-nav__button md-logo" aria-label="spectralmatch" data-md-component="logo">
      
  <img src="../../images/icon.png" alt="logo">

    </a>
    spectralmatch
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/spectralmatch/spectralmatch" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/spectralmatch/spectralmatch/releases" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/spectralmatch/spectralmatch/issues" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Report Issues
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../formats_and_requirements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    File Formats and Input Requirements
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/example_worldview_mosaic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WorldView Mosaic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/example_landsat_time_series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Landsat Time Series
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Benchmark Multithreading
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Matching Algorithms
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Matching Algorithms
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#spectralmatch.match.global_regression.global_regression" class="md-nav__link">
    <span class="md-ellipsis">
      global_regression
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectralmatch.match.local_block_adjustment.get_bounding_rect_images_block_space" class="md-nav__link">
    <span class="md-ellipsis">
      get_bounding_rect_images_block_space
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectralmatch.match.local_block_adjustment.get_pre_computed_block_maps" class="md-nav__link">
    <span class="md-ellipsis">
      get_pre_computed_block_maps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectralmatch.match.local_block_adjustment.local_block_adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      local_block_adjustment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectralmatch.match.local_block_adjustment.validate_pre_computed_block_maps" class="md-nav__link">
    <span class="md-ellipsis">
      validate_pre_computed_block_maps
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mask/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Mask and Pseudo-Invariant Features
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../statistics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Creating Statistical Figures
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../handlers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Handlers for IO
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#spectralmatch.match.global_regression.global_regression" class="md-nav__link">
    <span class="md-ellipsis">
      global_regression
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectralmatch.match.local_block_adjustment.get_bounding_rect_images_block_space" class="md-nav__link">
    <span class="md-ellipsis">
      get_bounding_rect_images_block_space
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectralmatch.match.local_block_adjustment.get_pre_computed_block_maps" class="md-nav__link">
    <span class="md-ellipsis">
      get_pre_computed_block_maps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectralmatch.match.local_block_adjustment.local_block_adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      local_block_adjustment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spectralmatch.match.local_block_adjustment.validate_pre_computed_block_maps" class="md-nav__link">
    <span class="md-ellipsis">
      validate_pre_computed_block_maps
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Matching Algorithms</h1>

<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="spectralmatch.match.global_regression.global_regression" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">global_regression</span><span class="p">(</span><span class="n">input_images</span><span class="p">,</span> <span class="n">output_images</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">custom_mean_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">custom_std_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vector_mask_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">custom_nodata_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parallel_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calculation_dtype_precision</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="n">specify_model_images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_adjustments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load_adjustments</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#spectralmatch.match.global_regression.global_regression" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Performs global radiometric normalization across overlapping images using least squares regression.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_images</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A folder path containing <code>.tif</code> files to search for or a list of input image paths.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_images</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="str">str</span>, <span title="str">str</span>] | <span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a tuple of (output_folder, suffix) to generate output paths from, or a list of output image paths. If a list is provided, its length must match the number of input images.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>custom_mean_factor</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Weight for mean constraints in regression. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>custom_std_factor</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Weight for standard deviation constraints in regression. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vector_mask_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional mask to limit stats to specific areas. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>window_size</code>
            </td>
            <td>
                  <code><span title="int">int</span> | <span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tile size for processing: int for square tiles, (width, height) for custom size, or None for full image. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debug_logs</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, prints debug information and constraint matrices. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>custom_nodata_value</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Overrides detected NoData value. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parallel_workers</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;cpu&#39;] | <span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set, enables multiprocessing. "cpu" = all cores, int = specific count, None = no parallel processing. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>calculation_dtype_precision</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type used for internal calculations. Defaults to "float32".</p>
              </div>
            </td>
            <td>
                  <code>&#39;float32&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>specify_model_images</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="typing.Literal">Literal</span>[&#39;exclude&#39;, &#39;include&#39;], <span title="typing.List">List</span>[<span title="str">str</span>]] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First item in tuples sets weather to 'include' or 'exclude' the listed images from model building statistics. Second item is the list of image names (without their extension) to apply criteria to. For example, if this param is only set to 'include' one image, all other images will be matched to that one image. Defaults to no exclusion.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_adjustments</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output path of a .json file to save adjustments parameters. Defaults to not saving.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>load_adjustments</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set, loads saved whole and overlapping statistics only for images that exist in the .json file. Other images will still have their statistics calculated. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[str]: Paths to the globally adjusted output raster images.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>spectralmatch/match/global_regression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">global_regression</span><span class="p">(</span>
    <span class="n">input_images</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">output_images</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">custom_mean_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">custom_std_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">vector_mask_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">debug_logs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">custom_nodata_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parallel_workers</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">calculation_dtype_precision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="n">specify_model_images</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;exclude&quot;</span><span class="p">,</span> <span class="s2">&quot;include&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_adjustments</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">load_adjustments</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs global radiometric normalization across overlapping images using least squares regression.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_images (str | List[str]): A folder path containing `.tif` files to search for or a list of input image paths.</span>
<span class="sd">        output_images (Tuple[str, str] | List[str]): Either a tuple of (output_folder, suffix) to generate output paths from, or a list of output image paths. If a list is provided, its length must match the number of input images.</span>
<span class="sd">        custom_mean_factor (float, optional): Weight for mean constraints in regression. Defaults to 1.0.</span>
<span class="sd">        custom_std_factor (float, optional): Weight for standard deviation constraints in regression. Defaults to 1.0.</span>
<span class="sd">        vector_mask_path (Optional[str], optional): Optional mask to limit stats to specific areas. Defaults to None.</span>
<span class="sd">        window_size (int | Tuple[int, int] | None): Tile size for processing: int for square tiles, (width, height) for custom size, or None for full image. Defaults to None.</span>
<span class="sd">        debug_logs (bool, optional): If True, prints debug information and constraint matrices. Defaults to False.</span>
<span class="sd">        custom_nodata_value (float | None, optional): Overrides detected NoData value. Defaults to None.</span>
<span class="sd">        parallel_workers (Literal[&quot;cpu&quot;] | int | None): If set, enables multiprocessing. &quot;cpu&quot; = all cores, int = specific count, None = no parallel processing. Defaults to None.</span>
<span class="sd">        calculation_dtype_precision (str, optional): Data type used for internal calculations. Defaults to &quot;float32&quot;.</span>
<span class="sd">        specify_model_images (Tuple[Literal[&quot;exclude&quot;, &quot;include&quot;], List[str]] | None ): First item in tuples sets weather to &#39;include&#39; or &#39;exclude&#39; the listed images from model building statistics. Second item is the list of image names (without their extension) to apply criteria to. For example, if this param is only set to &#39;include&#39; one image, all other images will be matched to that one image. Defaults to no exclusion.</span>
<span class="sd">        save_adjustments (str | None, optional): The output path of a .json file to save adjustments parameters. Defaults to not saving.</span>
<span class="sd">        load_adjustments (str | None, optional): If set, loads saved whole and overlapping statistics only for images that exist in the .json file. Other images will still have their statistics calculated. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[str]: Paths to the globally adjusted output raster images.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start global regression&quot;</span><span class="p">)</span>

    <span class="n">input_image_paths</span><span class="p">,</span> <span class="n">output_image_paths</span> <span class="o">=</span> <span class="n">_resolve_input_output_paths</span><span class="p">(</span><span class="n">input_images</span><span class="p">,</span> <span class="n">output_images</span><span class="p">)</span>
    <span class="n">input_image_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_image_paths</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">num_input_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_image_paths</span><span class="p">)</span>


    <span class="n">_check_raster_requirements</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">input_image_paths</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">debug_logs</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="n">window_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="n">window_size</span><span class="p">)</span>
    <span class="n">nodata_val</span> <span class="o">=</span> <span class="n">_get_nodata_value</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">input_image_paths</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">custom_nodata_value</span><span class="p">)</span>

    <span class="c1"># Find loaded and input files if load adjustments</span>
    <span class="n">loaded_model</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">load_adjustments</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">load_adjustments</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">loaded_model</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">_validate_adjustment_model_structure</span><span class="p">(</span><span class="n">loaded_model</span><span class="p">)</span>
        <span class="n">loaded_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">loaded_model</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">input_image_names</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loaded_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">input_image_names</span><span class="p">)</span>

    <span class="n">matched</span> <span class="o">=</span> <span class="n">input_names</span> <span class="o">&amp;</span> <span class="n">loaded_names</span>
    <span class="n">only_loaded</span> <span class="o">=</span> <span class="n">loaded_names</span> <span class="o">-</span> <span class="n">input_names</span>
    <span class="n">only_input</span> <span class="o">=</span> <span class="n">input_names</span> <span class="o">-</span> <span class="n">loaded_names</span>
    <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total images: input images: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_names</span><span class="p">)</span><span class="si">}</span><span class="s2">, loaded images </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded_names</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Matched adjustments (to override) (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">matched</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Only in loaded adjustments (to add) (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">only_loaded</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">only_loaded</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Only in input (to calculate) (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">only_input</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">only_input</span><span class="p">))</span>

    <span class="c1"># Find images to include in model</span>
    <span class="n">included_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matched</span> <span class="o">|</span> <span class="n">only_loaded</span> <span class="o">|</span> <span class="n">only_input</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">specify_model_images</span><span class="p">:</span>
        <span class="n">mode</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">specify_model_images</span>
        <span class="n">name_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;include&quot;</span><span class="p">:</span>
            <span class="n">included_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">input_image_names</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name_set</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;exclude&quot;</span><span class="p">:</span>
            <span class="n">included_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">input_image_names</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name_set</span><span class="p">]</span>
        <span class="n">excluded_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">input_image_names</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">included_names</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Images to influence the model:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Included in model (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">included_names</span><span class="p">)</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">included_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">specify_model_images</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Excluded from model (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">excluded_names</span><span class="p">)</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">excluded_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Excluded from model (0): []&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate stats</span>
    <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating statistics&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">input_image_paths</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span> <span class="n">num_bands</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span>

    <span class="c1"># Get images bounds</span>
    <span class="n">all_bounds</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">input_image_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
            <span class="n">all_bounds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">bounds</span>

    <span class="c1"># Calculate overlap stats</span>
    <span class="n">overlapping_pairs</span> <span class="o">=</span> <span class="n">_find_overlaps</span><span class="p">(</span><span class="n">all_bounds</span><span class="p">)</span>

    <span class="n">all_overlap_stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name_i</span><span class="p">,</span> <span class="n">name_j</span> <span class="ow">in</span> <span class="n">overlapping_pairs</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">name_i</span> <span class="ow">in</span> <span class="n">loaded_model</span> <span class="ow">and</span> <span class="n">name_j</span> <span class="ow">in</span> <span class="n">loaded_model</span><span class="p">[</span><span class="n">name_i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overlap_stats&quot;</span><span class="p">,</span> <span class="p">{}):</span>
            <span class="k">continue</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="n">_calculate_overlap_stats</span><span class="p">(</span>
            <span class="n">num_bands</span><span class="p">,</span>
            <span class="n">input_image_paths</span><span class="p">[</span><span class="n">name_i</span><span class="p">],</span>
            <span class="n">input_image_paths</span><span class="p">[</span><span class="n">name_j</span><span class="p">],</span>
            <span class="n">name_i</span><span class="p">,</span>
            <span class="n">name_j</span><span class="p">,</span>
            <span class="n">all_bounds</span><span class="p">[</span><span class="n">name_i</span><span class="p">],</span>
            <span class="n">all_bounds</span><span class="p">[</span><span class="n">name_j</span><span class="p">],</span>
            <span class="n">nodata_val</span><span class="p">,</span>
            <span class="n">nodata_val</span><span class="p">,</span>
            <span class="n">vector_mask_path</span><span class="o">=</span><span class="n">vector_mask_path</span><span class="p">,</span>
            <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span>
            <span class="n">debug_logs</span><span class="o">=</span><span class="n">debug_logs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">k_i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">all_overlap_stats</span><span class="p">[</span><span class="n">k_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">all_overlap_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k_i</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="n">k_j</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">all_overlap_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k_i</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k_j</span><span class="p">,</span> <span class="p">{}),</span> <span class="o">**</span><span class="n">s</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">k_j</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">},</span>
            <span class="p">}</span>


    <span class="c1"># Add loaded image stats to model</span>
    <span class="k">if</span> <span class="n">load_adjustments</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name_i</span><span class="p">,</span> <span class="n">model_entry</span> <span class="ow">in</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name_i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_image_paths</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">name_j</span><span class="p">,</span> <span class="n">bands</span> <span class="ow">in</span> <span class="n">model_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overlap_stats&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name_j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_image_paths</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">all_overlap_stats</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name_i</span><span class="p">,</span> <span class="p">{})[</span><span class="n">name_j</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span> <span class="p">{</span>
                        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">bands</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">bands</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;std&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">bands</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
                    <span class="p">}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">bands</span>
                <span class="p">}</span>

    <span class="c1"># Calculate whole stats</span>
    <span class="n">all_whole_stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">input_image_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">loaded_model</span><span class="p">:</span>
            <span class="n">all_whole_stats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span> <span class="p">{</span>
                    <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">loaded_model</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;whole_stats&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">loaded_model</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;whole_stats&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;std&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">loaded_model</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;whole_stats&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">loaded_model</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;whole_stats&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_whole_stats</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">_calculate_whole_stats</span><span class="p">(</span>
                    <span class="n">input_image_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">nodata</span><span class="o">=</span><span class="n">nodata_val</span><span class="p">,</span>
                    <span class="n">num_bands</span><span class="o">=</span><span class="n">num_bands</span><span class="p">,</span>
                    <span class="n">image_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">vector_mask_path</span><span class="o">=</span><span class="n">vector_mask_path</span><span class="p">,</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="n">all_image_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">input_image_names</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">loaded_model</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="n">num_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_image_names</span><span class="p">)</span>

    <span class="c1"># Print model sources</span>
    <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Creating model for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_image_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> total images from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">included_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> included:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;ID&#39;</span><span class="si">:</span><span class="s2">&lt;4</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="s1">&#39;Source&#39;</span><span class="si">:</span><span class="s2">&lt;6</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="s1">&#39;Inclusion&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="se">\t</span><span class="s2">Name&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_image_names</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;load&quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">matched</span> <span class="o">|</span> <span class="n">only_loaded</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;calc&quot;</span>
            <span class="n">included</span> <span class="o">=</span> <span class="s2">&quot;incl&quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">included_names</span> <span class="k">else</span> <span class="s2">&quot;excl&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">&lt;4</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">source</span><span class="si">:</span><span class="s2">&lt;6</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">included</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Build model</span>
    <span class="n">all_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_bands</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_total</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">image_names_with_id</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_image_names</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bands</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing band </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>

        <span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">tot_overlap</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name_i</span> <span class="ow">in</span> <span class="n">image_names_with_id</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">name_j</span> <span class="ow">in</span> <span class="n">image_names_with_id</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">all_overlap_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name_i</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name_j</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># This condition ensures that only overlaps involving at least one included image contribute constraints, allowing external images to be calibrated against the model without influencing it.</span>
                <span class="k">if</span> <span class="n">name_i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">included_names</span> <span class="ow">and</span> <span class="n">name_j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">included_names</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
                <span class="n">m1</span><span class="p">,</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="s2">&quot;std&quot;</span><span class="p">]</span>
                <span class="n">m2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">all_overlap_stats</span><span class="p">[</span><span class="n">name_j</span><span class="p">][</span><span class="n">name_i</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span>
                    <span class="n">all_overlap_stats</span><span class="p">[</span><span class="n">name_j</span><span class="p">][</span><span class="n">name_i</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="s2">&quot;std&quot;</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="n">row_m</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_total</span><span class="p">)</span>
                <span class="n">row_s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_total</span><span class="p">)</span>
                <span class="n">row_m</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">row_m</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">m2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">row_s</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> <span class="n">row_s</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span><span class="p">,</span> <span class="o">-</span><span class="n">v2</span>

                <span class="n">A</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                    <span class="p">[</span><span class="n">v</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">custom_mean_factor</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row_m</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">v</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">custom_std_factor</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row_s</span><span class="p">],</span>
                <span class="p">])</span>
                <span class="n">y</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">tot_overlap</span> <span class="o">+=</span> <span class="n">s</span>

        <span class="n">pjj</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">tot_overlap</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">tot_overlap</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">num_total</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">included_names</span><span class="p">:</span>
            <span class="n">mj</span> <span class="o">=</span> <span class="n">all_whole_stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
            <span class="n">vj</span> <span class="o">=</span> <span class="n">all_whole_stats</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="s2">&quot;std&quot;</span><span class="p">]</span>
            <span class="n">j_idx</span> <span class="o">=</span> <span class="n">all_image_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">row_m</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_total</span><span class="p">)</span>
            <span class="n">row_s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_total</span><span class="p">)</span>
            <span class="n">row_m</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j_idx</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">j_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mj</span> <span class="o">*</span> <span class="n">pjj</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">pjj</span><span class="p">]</span>
            <span class="n">row_s</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">vj</span> <span class="o">*</span> <span class="n">pjj</span>
            <span class="n">A</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">row_m</span><span class="p">,</span> <span class="n">row_s</span><span class="p">])</span>
            <span class="n">y</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">mj</span> <span class="o">*</span> <span class="n">pjj</span><span class="p">,</span> <span class="n">vj</span> <span class="o">*</span> <span class="n">pjj</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">input_image_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">included_names</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_total</span><span class="p">)</span>
            <span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">A_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">y_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">A_arr</span> <span class="o">@</span> <span class="n">p</span> <span class="o">-</span> <span class="n">y_arr</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_total</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span>
            <span class="n">_print_constraint_system</span><span class="p">(</span>
                <span class="n">constraint_matrix</span><span class="o">=</span><span class="n">A_arr</span><span class="p">,</span>
                <span class="n">adjustment_params</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">observed_values_vector</span><span class="o">=</span><span class="n">y_arr</span><span class="p">,</span>
                <span class="n">overlap_pairs</span><span class="o">=</span><span class="n">overlapping_pairs</span><span class="p">,</span>
                <span class="n">image_names_with_id</span><span class="o">=</span><span class="n">image_names_with_id</span><span class="p">,</span>

            <span class="p">)</span>

        <span class="n">all_params</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_total</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Save adjustments</span>
    <span class="k">if</span> <span class="n">save_adjustments</span><span class="p">:</span>
        <span class="n">_save_adjustments</span><span class="p">(</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">save_adjustments</span><span class="p">,</span>
            <span class="n">input_image_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">input_image_paths</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">all_params</span><span class="o">=</span><span class="n">all_params</span><span class="p">,</span>
            <span class="n">all_whole_stats</span><span class="o">=</span><span class="n">all_whole_stats</span><span class="p">,</span>
            <span class="n">all_overlap_stats</span><span class="o">=</span><span class="n">all_overlap_stats</span><span class="p">,</span>
            <span class="n">num_bands</span><span class="o">=</span><span class="n">num_bands</span><span class="p">,</span>
            <span class="n">calculation_dtype_precision</span><span class="o">=</span><span class="n">calculation_dtype_precision</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">parallel_workers</span> <span class="o">==</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">max_workers</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parallel_workers</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">parallel_workers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">max_workers</span> <span class="o">=</span> <span class="n">parallel_workers</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">max_workers</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">out_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">img_path</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_image_paths</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">output_image_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">out_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_path</span><span class="p">)):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Apply adjustments and saving results for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">num_bands</span><span class="p">,</span> <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="n">nodata_val</span><span class="p">})</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">window_size</span><span class="p">:</span>
                    <span class="n">tw</span><span class="p">,</span> <span class="n">th</span> <span class="o">=</span> <span class="n">window_size</span>
                    <span class="n">windows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_create_windows</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">tw</span><span class="p">,</span> <span class="n">th</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="n">Window</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">)]</span>

                <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
                    <span class="n">ctx</span> <span class="o">=</span> <span class="n">_choose_context</span><span class="p">(</span><span class="n">prefer_fork</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">pool</span> <span class="o">=</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span>
                        <span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">,</span>
                        <span class="n">mp_context</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
                        <span class="n">initializer</span><span class="o">=</span><span class="n">_init_worker</span><span class="p">,</span>
                        <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">img_path</span><span class="p">,),</span>
                    <span class="p">)</span>

                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bands</span><span class="p">):</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">all_params</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">b0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">all_params</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
                        <span class="n">futs</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_process_tile_global</span><span class="p">,</span>
                                        <span class="n">w</span><span class="p">,</span>
                                        <span class="n">b</span><span class="p">,</span>
                                        <span class="n">a</span><span class="p">,</span>
                                        <span class="n">b0</span><span class="p">,</span>
                                        <span class="n">nodata_val</span><span class="p">,</span>
                                        <span class="n">calculation_dtype_precision</span><span class="p">,</span>
                                        <span class="n">debug_logs</span><span class="p">,</span>
                                        <span class="p">)</span>
                            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">windows</span>
                        <span class="p">]</span>
                        <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futs</span><span class="p">):</span>
                            <span class="n">win</span><span class="p">,</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]),</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">win</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">win</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">_process_tile_global</span><span class="p">(</span>
                                <span class="n">win</span><span class="p">,</span>
                                <span class="n">b</span><span class="p">,</span>
                                <span class="n">a</span><span class="p">,</span>
                                <span class="n">b0</span><span class="p">,</span>
                                <span class="n">nodata_val</span><span class="p">,</span>
                                <span class="n">debug_logs</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]),</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">win</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished global regression&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_paths</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="spectralmatch.match.local_block_adjustment.get_bounding_rect_images_block_space" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_bounding_rect_images_block_space</span><span class="p">(</span><span class="n">block_valid_counts</span><span class="p">)</span></code>

<a href="#spectralmatch.match.local_block_adjustment.get_bounding_rect_images_block_space" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Compute block-space bounding rectangles for each image based on valid pixel counts.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>block_valid_counts</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shape (num_images, num_row, num_col, num_bands)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray of shape (num_images, 4): each row is (min_row, min_col, max_row, max_col)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>spectralmatch/match/local_block_adjustment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_bounding_rect_images_block_space</span><span class="p">(</span>
    <span class="n">block_valid_counts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute block-space bounding rectangles for each image based on valid pixel counts.</span>

<span class="sd">    Args:</span>
<span class="sd">        block_valid_counts (np.ndarray): Shape (num_images, num_row, num_col, num_bands)</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray of shape (num_images, 4): each row is (min_row, min_col, max_row, max_col)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_images</span><span class="p">,</span> <span class="n">num_row</span><span class="p">,</span> <span class="n">num_col</span><span class="p">,</span> <span class="n">num_bands</span> <span class="o">=</span> <span class="n">block_valid_counts</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_images</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">block_valid_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rows</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cols</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">min_row</span><span class="p">,</span> <span class="n">max_row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">rows</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">min_col</span><span class="p">,</span> <span class="n">max_col</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">cols</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_row</span> <span class="o">=</span> <span class="n">max_row</span> <span class="o">=</span> <span class="n">min_col</span> <span class="o">=</span> <span class="n">max_col</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_row</span><span class="p">,</span> <span class="n">min_col</span><span class="p">,</span> <span class="n">max_row</span><span class="p">,</span> <span class="n">max_col</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="spectralmatch.match.local_block_adjustment.get_pre_computed_block_maps" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_pre_computed_block_maps</span><span class="p">(</span><span class="n">load_block_maps</span><span class="p">,</span> <span class="n">calculation_dtype_precision</span><span class="p">)</span></code>

<a href="#spectralmatch.match.local_block_adjustment.get_pre_computed_block_maps" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Load pre-computed block mean maps from files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>load_block_maps</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="str">str</span>, <span title="list">list</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>First element is the reference block map file path (str), used to determine block dimensions and canvas extent.</li>
<li>Second element is a list of local block map file paths (List[str]), each corresponding by index to input images.</li>
</ul>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>calculation_dtype_precision</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Used as the dtype to read input rasters and return data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[
np.ndarray,  # block_local_means: shape (num_images, num_row, num_col, num_bands)
np.ndarray,  # block_reference_mean: shape (num_row, num_col, num_bands)
int,         # num_row
int,         # num_col
Tuple[float, float, float, float]  # bounds_canvas_coords (minx, miny, maxx, maxy)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>spectralmatch/match/local_block_adjustment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_pre_computed_block_maps</span><span class="p">(</span>
    <span class="n">load_block_maps</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">calculation_dtype_precision</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load pre-computed block mean maps from files.</span>

<span class="sd">    Args:</span>
<span class="sd">        load_block_maps (tuple[str, list[str]]):</span>
<span class="sd">            - First element is the reference block map file path (str), used to determine block dimensions and canvas extent.</span>
<span class="sd">            - Second element is a list of local block map file paths (List[str]), each corresponding by index to input images.</span>
<span class="sd">        calculation_dtype_precision (str): Used as the dtype to read input rasters and return data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[</span>
<span class="sd">            np.ndarray,  # block_local_means: shape (num_images, num_row, num_col, num_bands)</span>
<span class="sd">            np.ndarray,  # block_reference_mean: shape (num_row, num_col, num_bands)</span>
<span class="sd">            int,         # num_row</span>
<span class="sd">            int,         # num_col</span>
<span class="sd">            Tuple[float, float, float, float]  # bounds_canvas_coords (minx, miny, maxx, maxy)</span>
<span class="sd">        ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ref_path</span><span class="p">,</span> <span class="n">local_paths</span> <span class="o">=</span> <span class="n">load_block_maps</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">ref_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">calculation_dtype_precision</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">nodata_val</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span>
        <span class="k">if</span> <span class="n">nodata_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_data</span><span class="p">[</span><span class="n">ref_data</span> <span class="o">==</span> <span class="n">nodata_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">block_reference_mean</span> <span class="o">=</span> <span class="n">ref_data</span>
        <span class="n">bounds_canvas_coords</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>

    <span class="n">block_local_means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">local_paths</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">calculation_dtype_precision</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">nodata_val</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span>
            <span class="k">if</span> <span class="n">nodata_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="n">nodata_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">block_local_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">block_local_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">block_local_means</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">num_row</span><span class="p">,</span> <span class="n">num_col</span> <span class="o">=</span> <span class="n">block_reference_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded reference block map and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">local_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> local block maps. Shape: (</span><span class="si">{</span><span class="n">num_row</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">num_col</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">block_reference_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">block_local_means</span><span class="p">,</span> <span class="n">block_reference_mean</span><span class="p">,</span> <span class="n">num_row</span><span class="p">,</span> <span class="n">num_col</span><span class="p">,</span> <span class="n">bounds_canvas_coords</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="spectralmatch.match.local_block_adjustment.local_block_adjustment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">local_block_adjustment</span><span class="p">(</span><span class="n">input_images</span><span class="p">,</span> <span class="n">output_images</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">output_local_basename</span><span class="o">=</span><span class="s1">&#39;_local&#39;</span><span class="p">,</span> <span class="n">custom_nodata_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">number_of_blocks</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">calculation_dtype_precision</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="n">output_dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="n">debug_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">correction_method</span><span class="o">=</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="n">parallel_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_block_maps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">load_block_maps</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#spectralmatch.match.local_block_adjustment.local_block_adjustment" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Performs local radiometric adjustment on a set of raster images using block-based statistics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_images</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A folder path containing <code>.tif</code> files to search for or a list of input image paths.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_images</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="str">str</span>, <span title="str">str</span>] | <span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a tuple of (output_folder, suffix) to generate output paths from, or a list of output image paths. If a list is provided, its length must match the number of input images.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_local_basename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Suffix for output filenames. Defaults to "_local".</p>
              </div>
            </td>
            <td>
                  <code>&#39;_local&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>custom_nodata_value</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Overrides detected NoData value. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>number_of_blocks</code>
            </td>
            <td>
                  <code><span title="int">int</span> | <span title="tuple">tuple</span> | <span title="typing.Literal">Literal</span>[&#39;coefficient_of_variation&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>int as a target of blocks per image, tuple to set manually set total blocks width and height, coefficient_of_variation to find the number of blocks based on this metric.</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Blending factor between global and local means. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>calculation_dtype_precision</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Precision for internal calculations. Defaults to "float32".</p>
              </div>
            </td>
            <td>
                  <code>&#39;float32&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type for output rasters. Defaults to "float32".</p>
              </div>
            </td>
            <td>
                  <code>&#39;float32&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debug_logs</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, prints progress. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>window_size</code>
            </td>
            <td>
                  <code><span title="int">int</span> | <span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>] | None | <span title="typing.Literal">Literal</span>[&#39;block&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tile size for processing: int for square tiles, (width, height) for custom size, None for full image, or "block" to set as the size of the block map. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>correction_method</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;gamma&#39;, &#39;linear&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Local correction method. Defaults to "gamma".</p>
              </div>
            </td>
            <td>
                  <code>&#39;gamma&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parallel_workers</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;cpu&#39;] | <span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set, enables multiprocessing. "cpu" = all cores, int = specific count, None = no parallel processing. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_block_maps</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, saves intermediate results for examination or to start midway through with block maps. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>load_block_maps</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="str">str</span>, <span title="typing.List">List</span>[<span title="str">str</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing:
    - A reference block map path (str): This is used for the reference dataset, sets the canvas extent, and determines the number of blocks.
    - A list of local block map paths (List[str]): Each path corresponds to an image in input_image_paths by position and will be used for the local dataset. The list must have the same length as input_image_paths.</p>
<p>This is used to:
    - Load the reference block mean map.
    - Load each image's local block mean map.
    - Enable saving intermediate results after block computation and after each image is processed (you can remove a local image from processing and still get the same results as long as it was used for initial calculation).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[str]: Paths to the locally adjusted output raster images.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>spectralmatch/match/local_block_adjustment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">local_block_adjustment</span><span class="p">(</span>
    <span class="n">input_images</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">output_images</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">output_local_basename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_local&quot;</span><span class="p">,</span>
    <span class="n">custom_nodata_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">number_of_blocks</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;coefficient_of_variation&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">calculation_dtype_precision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="n">output_dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="n">debug_logs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">correction_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gamma&quot;</span><span class="p">,</span>
    <span class="n">parallel_workers</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_block_maps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">load_block_maps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span><span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs local radiometric adjustment on a set of raster images using block-based statistics.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_images (str | List[str]): A folder path containing `.tif` files to search for or a list of input image paths.</span>
<span class="sd">        output_images (Tuple[str, str] | List[str]): Either a tuple of (output_folder, suffix) to generate output paths from, or a list of output image paths. If a list is provided, its length must match the number of input images.</span>
<span class="sd">        output_local_basename (str, optional): Suffix for output filenames. Defaults to &quot;_local&quot;.</span>
<span class="sd">        custom_nodata_value (float | None, optional): Overrides detected NoData value. Defaults to None.</span>
<span class="sd">        number_of_blocks (int | tuple | Literal[&quot;coefficient_of_variation&quot;]): int as a target of blocks per image, tuple to set manually set total blocks width and height, coefficient_of_variation to find the number of blocks based on this metric.</span>
<span class="sd">        alpha (float, optional): Blending factor between global and local means. Defaults to 1.0.</span>
<span class="sd">        calculation_dtype_precision (str, optional): Precision for internal calculations. Defaults to &quot;float32&quot;.</span>
<span class="sd">        output_dtype (str, optional): Data type for output rasters. Defaults to &quot;float32&quot;.</span>
<span class="sd">        debug_logs (bool, optional): If True, prints progress. Defaults to False.</span>
<span class="sd">        window_size (int | Tuple[int, int] | None | Literal[&quot;block&quot;]): Tile size for processing: int for square tiles, (width, height) for custom size, None for full image, or &quot;block&quot; to set as the size of the block map. Defaults to None.</span>
<span class="sd">        correction_method (Literal[&quot;gamma&quot;, &quot;linear&quot;], optional): Local correction method. Defaults to &quot;gamma&quot;.</span>
<span class="sd">        parallel_workers (Literal[&quot;cpu&quot;] | int | None): If set, enables multiprocessing. &quot;cpu&quot; = all cores, int = specific count, None = no parallel processing. Defaults to None.</span>
<span class="sd">        save_block_maps (bool, optional): If True, saves intermediate results for examination or to start midway through with block maps. Defaults to False.</span>
<span class="sd">        load_block_maps (Optional[Tuple[str, List[str]]]):</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">                - A reference block map path (str): This is used for the reference dataset, sets the canvas extent, and determines the number of blocks.</span>
<span class="sd">                - A list of local block map paths (List[str]): Each path corresponds to an image in input_image_paths by position and will be used for the local dataset. The list must have the same length as input_image_paths.</span>

<span class="sd">            This is used to:</span>
<span class="sd">                - Load the reference block mean map.</span>
<span class="sd">                - Load each image&#39;s local block mean map.</span>
<span class="sd">                - Enable saving intermediate results after block computation and after each image is processed (you can remove a local image from processing and still get the same results as long as it was used for initial calculation).</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[str]: Paths to the locally adjusted output raster images.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start local block adjustment&quot;</span><span class="p">)</span>

    <span class="n">input_image_paths</span><span class="p">,</span> <span class="n">output_image_paths</span> <span class="o">=</span> <span class="n">_resolve_input_output_paths</span><span class="p">(</span><span class="n">input_images</span><span class="p">,</span> <span class="n">output_images</span><span class="p">)</span>
    <span class="n">input_image_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_image_paths</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">_check_raster_requirements</span><span class="p">(</span><span class="n">input_image_paths</span><span class="p">,</span> <span class="n">debug_logs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_image_folder</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_image_folder</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="n">window_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="n">window_size</span><span class="p">)</span>
    <span class="n">input_image_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">input_image_paths</span><span class="p">]</span>

    <span class="c1"># Load data from precomputed block maps if set</span>
    <span class="k">if</span> <span class="n">load_block_maps</span><span class="p">:</span>
        <span class="n">block_local_means</span><span class="p">,</span> <span class="n">block_reference_mean</span><span class="p">,</span> <span class="n">num_row</span><span class="p">,</span> <span class="n">num_col</span><span class="p">,</span> <span class="n">bounds_canvas_coords</span> <span class="o">=</span> <span class="n">get_pre_computed_block_maps</span><span class="p">(</span><span class="n">load_block_maps</span><span class="p">,</span> <span class="n">calculation_dtype_precision</span><span class="p">)</span>
        <span class="n">validate_pre_computed_block_maps</span><span class="p">(</span><span class="n">block_local_means</span><span class="p">,</span> <span class="n">block_reference_mean</span><span class="p">,</span> <span class="n">num_row</span><span class="p">,</span> <span class="n">num_col</span><span class="p">,</span> <span class="n">bounds_canvas_coords</span><span class="p">,</span> <span class="n">input_image_paths</span><span class="p">)</span>
        <span class="n">loaded_block_map_reference_path</span><span class="p">,</span> <span class="n">loaded_block_map_local_paths</span> <span class="o">=</span> <span class="n">load_block_maps</span>
        <span class="n">loaded_block_map_reference_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">loaded_block_map_reference_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">loaded_block_map_local_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">loaded_block_map_local_paths</span><span class="p">]</span>


    <span class="n">nodata_val</span> <span class="o">=</span> <span class="n">_get_nodata_value</span><span class="p">(</span><span class="n">input_image_paths</span><span class="p">,</span> <span class="n">custom_nodata_value</span><span class="p">)</span>
    <span class="n">projection</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_image_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">crs</span>
    <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Global nodata value: </span><span class="si">{</span><span class="n">nodata_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">bounds_images_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">input_image_paths</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_image_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span><span class="n">num_bands</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">count</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">load_block_maps</span><span class="p">:</span> <span class="n">bounds_canvas_coords</span> <span class="o">=</span> <span class="n">_get_bounding_rectangle</span><span class="p">(</span><span class="n">input_image_paths</span><span class="p">)</span>


    <span class="c1"># Calculate the number of blocks</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">load_block_maps</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">number_of_blocks</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">num_row</span><span class="p">,</span> <span class="n">num_col</span> <span class="o">=</span> <span class="n">_compute_block_size</span><span class="p">(</span><span class="n">input_image_paths</span><span class="p">,</span> <span class="n">number_of_blocks</span><span class="p">,</span> <span class="n">bounds_canvas_coords</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">number_of_blocks</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">num_row</span><span class="p">,</span> <span class="n">num_col</span> <span class="o">=</span> <span class="n">number_of_blocks</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">number_of_blocks</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">num_row</span><span class="p">,</span> <span class="n">num_col</span> <span class="o">=</span> <span class="n">_compute_mosaic_coefficient_of_variation</span><span class="p">(</span><span class="n">input_image_paths</span><span class="p">,</span> <span class="n">nodata_val</span><span class="p">)</span> <span class="c1"># This is the approach from the paper to compute bock size</span>

    <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing local block map&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">load_block_maps</span><span class="p">:</span>
        <span class="n">block_local_means</span><span class="p">,</span> <span class="n">block_local_counts</span> <span class="o">=</span> <span class="n">_compute_local_blocks</span><span class="p">(</span>
            <span class="n">input_image_paths</span><span class="p">,</span>
            <span class="n">bounds_canvas_coords</span><span class="p">,</span>
            <span class="n">num_row</span><span class="p">,</span>
            <span class="n">num_col</span><span class="p">,</span>
            <span class="n">num_bands</span><span class="p">,</span>
            <span class="n">window_size</span><span class="p">,</span>
            <span class="n">debug_logs</span><span class="p">,</span>
            <span class="n">nodata_val</span><span class="p">,</span>
            <span class="n">calculation_dtype_precision</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">bounds_images_block_space</span> <span class="o">=</span> <span class="n">get_bounding_rect_images_block_space</span><span class="p">(</span><span class="n">block_local_means</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing reference block map&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">load_block_maps</span><span class="p">:</span>
        <span class="n">block_reference_mean</span> <span class="o">=</span> <span class="n">_compute_reference_blocks</span><span class="p">(</span>
            <span class="n">block_local_means</span><span class="p">,</span>
            <span class="n">block_local_counts</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">save_block_maps</span><span class="p">:</span>
        <span class="n">_download_block_map</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">block_reference_mean</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="n">nodata_val</span><span class="p">),</span>
            <span class="n">bounds_canvas_coords</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_image_folder</span><span class="p">,</span> <span class="s2">&quot;BlockReferenceMean&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;BlockReferenceMean.tif&quot;</span><span class="p">),</span>
            <span class="n">projection</span><span class="p">,</span>
            <span class="n">calculation_dtype_precision</span><span class="p">,</span>
            <span class="n">nodata_val</span><span class="p">,</span>
            <span class="n">num_col</span><span class="p">,</span>
            <span class="n">num_row</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">img_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">block_local_mean</span><span class="p">,</span> <span class="n">input_image_name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">block_local_means</span><span class="p">,</span> <span class="n">input_image_names</span><span class="p">)):</span>
            <span class="n">_download_block_map</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">block_local_mean</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="n">nodata_val</span><span class="p">),</span>
                <span class="n">bounds_canvas_coords</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_image_folder</span><span class="p">,</span> <span class="s2">&quot;BlockLocalMean&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">input_image_name</span><span class="si">}</span><span class="s2">_BlockLocalMean.tif&quot;</span><span class="p">),</span>
                <span class="n">projection</span><span class="p">,</span>
                <span class="n">calculation_dtype_precision</span><span class="p">,</span>
                <span class="n">nodata_val</span><span class="p">,</span>
                <span class="n">num_col</span><span class="p">,</span>
                <span class="n">num_row</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># _download_block_map(</span>
            <span class="c1">#     np.nan_to_num(block_local_count, nan=nodata_val),</span>
            <span class="c1">#     bounds_canvas_coords,</span>
            <span class="c1">#     os.path.join(output_image_folder, &quot;BlockLocalCount&quot;, f&quot;{input_image_name}_BlockLocalCount.tif&quot;),</span>
            <span class="c1">#     projection,</span>
            <span class="c1">#     calculation_dtype_precision,</span>
            <span class="c1">#     nodata_val,</span>
            <span class="c1">#     num_col,</span>
            <span class="c1">#     num_row,</span>
            <span class="c1"># )</span>

    <span class="c1"># block_local_mean = _smooth_array(block_local_mean, nodata_value=global_nodata_value)</span>

    <span class="k">if</span> <span class="n">parallel_workers</span> <span class="o">==</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">max_workers</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parallel_workers</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">parallel_workers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">max_workers</span> <span class="o">=</span> <span class="n">parallel_workers</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">max_workers</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">out_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">img_idx</span><span class="p">,</span> <span class="n">img_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_image_paths</span><span class="p">):</span>
        <span class="n">in_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">out_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">output_local_basename</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_image_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_name</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
        <span class="n">out_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">in_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing local correction, applying, and saving&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">num_bands</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">output_dtype</span><span class="p">,</span> <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="n">nodata_val</span><span class="p">})</span>
            <span class="n">block_reference_mean_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">block_reference_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">bounds_images_block_space</span><span class="p">[</span><span class="n">img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">block_reference_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bounds_images_block_space</span><span class="p">[</span><span class="n">img_idx</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">block_reference_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">bounds_images_block_space</span><span class="p">[</span><span class="n">img_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">block_reference_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bounds_images_block_space</span><span class="p">[</span><span class="n">img_idx</span><span class="p">][</span><span class="mi">3</span><span class="p">]),</span>
                <span class="n">block_reference_mean</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">tw</span><span class="p">,</span> <span class="n">th</span> <span class="o">=</span> <span class="n">window_size</span>
                <span class="n">windows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_create_windows</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">tw</span><span class="p">,</span> <span class="n">th</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">window_size</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span><span class="p">:</span>
                <span class="n">block_width_geo</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds_canvas_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds_canvas_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">num_col</span>
                <span class="n">block_height_geo</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds_canvas_coords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds_canvas_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">num_row</span>
                <span class="n">res_x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
                <span class="n">res_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>
                <span class="n">tile_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">block_width_geo</span> <span class="o">/</span> <span class="n">res_x</span><span class="p">)))</span>
                <span class="n">tile_height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">block_height_geo</span> <span class="o">/</span> <span class="n">res_y</span><span class="p">)))</span>
                <span class="n">windows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_create_windows</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">,</span> <span class="n">tile_height</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">window_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="n">Window</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">)]</span>
            <span class="c1"># if debug_logs: print(f&quot;BandIDWindowID[xStart:yStart xSizeXySize] ({len(windows)} windows): &quot;, end=&quot;&quot;)</span>

            <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="n">_choose_context</span><span class="p">(</span><span class="n">prefer_fork</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">ref_shm</span> <span class="o">=</span> <span class="n">shared_memory</span><span class="o">.</span><span class="n">SharedMemory</span><span class="p">(</span><span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">block_reference_mean</span><span class="o">.</span><span class="n">nbytes</span><span class="p">)</span>
                <span class="n">ref_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">block_reference_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">block_reference_mean</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">ref_shm</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>
                <span class="n">ref_array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">block_reference_mean</span><span class="p">[:]</span>

                <span class="n">loc_shm</span> <span class="o">=</span> <span class="n">shared_memory</span><span class="o">.</span><span class="n">SharedMemory</span><span class="p">(</span><span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">block_local_means</span><span class="p">[</span><span class="n">img_idx</span><span class="p">]</span><span class="o">.</span><span class="n">nbytes</span><span class="p">)</span>
                <span class="n">loc_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">block_local_means</span><span class="p">[</span><span class="n">img_idx</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">block_local_means</span><span class="p">[</span><span class="n">img_idx</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">loc_shm</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>
                <span class="n">loc_array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">block_local_means</span><span class="p">[</span><span class="n">img_idx</span><span class="p">][:]</span>

                <span class="n">pool</span> <span class="o">=</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span>
                    <span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">,</span>
                    <span class="n">mp_context</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
                    <span class="n">initializer</span><span class="o">=</span><span class="n">_init_worker</span><span class="p">,</span>
                    <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">ref_shm</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">loc_shm</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">block_reference_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">block_local_means</span><span class="p">[</span><span class="n">img_idx</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">block_reference_mean</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                        <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_compute_tile_local</span><span class="p">,</span>
                                        <span class="n">w</span><span class="p">,</span>
                                        <span class="n">b</span><span class="p">,</span>
                                        <span class="n">num_row</span><span class="p">,</span>
                                        <span class="n">num_col</span><span class="p">,</span>
                                        <span class="n">bounds_canvas_coords</span><span class="p">,</span>
                                        <span class="n">bounds_images_coords</span><span class="p">[</span><span class="n">img_idx</span><span class="p">],</span>
                                        <span class="n">block_reference_mean_masked</span><span class="p">,</span>
                                        <span class="n">block_local_means</span><span class="p">[</span><span class="n">img_idx</span><span class="p">],</span>
                                        <span class="n">nodata_val</span><span class="p">,</span>
                                        <span class="n">alpha</span><span class="p">,</span>
                                        <span class="n">correction_method</span><span class="p">,</span>
                                        <span class="n">calculation_dtype_precision</span><span class="p">,</span>
                                        <span class="n">debug_logs</span><span class="p">,</span>
                                        <span class="n">w_id</span><span class="p">,</span>
                                        <span class="n">output_image_folder</span><span class="p">,</span>
                                        <span class="n">out_name</span><span class="p">,</span>
                                        <span class="n">projection</span><span class="p">,</span>
                                        <span class="n">num_bands</span><span class="p">,</span>
                                        <span class="n">save_block_maps</span><span class="p">,</span>
                                        <span class="p">)</span>
                            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bands</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">w_id</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span>
                        <span class="p">]</span>
                        <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                            <span class="n">win</span><span class="p">,</span> <span class="n">b_idx</span><span class="p">,</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">output_dtype</span><span class="p">),</span> <span class="n">b_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">win</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">buf</span><span class="p">,</span> <span class="n">win</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ref_shm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">loc_shm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">ref_shm</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                    <span class="n">loc_shm</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                    <span class="n">_worker_dataset_cache</span><span class="p">[</span><span class="s2">&quot;ds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
                    <span class="n">_worker_dataset_cache</span><span class="p">[</span><span class="s2">&quot;block_ref_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_reference_mean</span>
                    <span class="n">_worker_dataset_cache</span><span class="p">[</span><span class="s2">&quot;block_loc_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_local_means</span><span class="p">[</span><span class="n">img_idx</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bands</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">w_id</span><span class="p">,</span> <span class="n">win</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">windows</span><span class="p">):</span>
                            <span class="n">win_</span><span class="p">,</span> <span class="n">b_idx</span><span class="p">,</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">_compute_tile_local</span><span class="p">(</span>
                                <span class="n">win</span><span class="p">,</span>
                                <span class="n">b</span><span class="p">,</span>
                                <span class="n">num_row</span><span class="p">,</span>
                                <span class="n">num_col</span><span class="p">,</span>
                                <span class="n">bounds_canvas_coords</span><span class="p">,</span>
                                <span class="n">bounds_images_coords</span><span class="p">[</span><span class="n">img_idx</span><span class="p">],</span>
                                <span class="n">block_reference_mean_masked</span><span class="p">,</span>
                                <span class="n">block_local_means</span><span class="p">[</span><span class="n">img_idx</span><span class="p">],</span>
                                <span class="n">nodata_val</span><span class="p">,</span>
                                <span class="n">alpha</span><span class="p">,</span>
                                <span class="n">correction_method</span><span class="p">,</span>
                                <span class="n">calculation_dtype_precision</span><span class="p">,</span>
                                <span class="n">debug_logs</span><span class="p">,</span>
                                <span class="n">w_id</span><span class="p">,</span>
                                <span class="n">output_image_folder</span><span class="p">,</span>
                                <span class="n">out_name</span><span class="p">,</span>
                                <span class="n">projection</span><span class="p">,</span>
                                <span class="n">num_bands</span><span class="p">,</span>
                                <span class="n">save_block_maps</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">output_dtype</span><span class="p">),</span> <span class="n">b_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">win_</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">buf</span><span class="p">,</span> <span class="n">win_</span>
            <span class="k">if</span> <span class="n">debug_logs</span><span class="p">:</span> <span class="nb">print</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parallel</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;ds&quot;</span> <span class="ow">in</span> <span class="n">_worker_dataset_cache</span><span class="p">:</span>
                    <span class="n">_worker_dataset_cache</span><span class="p">[</span><span class="s2">&quot;ds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">del</span> <span class="n">_worker_dataset_cache</span><span class="p">[</span><span class="s2">&quot;ds&quot;</span><span class="p">]</span>
                <span class="n">_worker_dataset_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;block_ref_mean&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">_worker_dataset_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;block_loc_mean&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">del</span> <span class="n">block_reference_mean_masked</span><span class="p">,</span> <span class="n">windows</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished local block adjustment&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_paths</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="spectralmatch.match.local_block_adjustment.validate_pre_computed_block_maps" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_pre_computed_block_maps</span><span class="p">(</span><span class="n">block_local_means</span><span class="p">,</span> <span class="n">input_image_paths</span><span class="p">)</span></code>

<a href="#spectralmatch.match.local_block_adjustment.validate_pre_computed_block_maps" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Validate consistency between pre-computed block maps and expected input image metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>block_local_means</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of shape (num_images, num_row, num_col, num_bands).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>input_image_paths</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of input image file paths.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if any inconsistency is found.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>spectralmatch/match/local_block_adjustment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_pre_computed_block_maps</span><span class="p">(</span>
    <span class="n">block_local_means</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">input_image_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate consistency between pre-computed block maps and expected input image metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        block_local_means: Array of shape (num_images, num_row, num_col, num_bands).</span>
<span class="sd">        input_image_paths: List of input image file paths.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: if any inconsistency is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_image_paths</span><span class="p">)</span> <span class="o">!=</span> <span class="n">block_local_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of input images does not match number of local block maps.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of local block maps matches input images&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    2025-05-02
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "search.highlight"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>